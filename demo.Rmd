---
title: "SubnationalCRVS Demo"
author: "Jeremy Roth"
date: ''
output:
  pdf_document:
    number_sections: yes
    toc: yes
header-includes:
 \usepackage{float}
---

```{r "clear", include=FALSE}
rm(list=ls())
```

# Set up
```{r "load_package", message=FALSE, warning=FALSE}
#library(devtools)
#install_github("jroth-unfpa/SubnationalCRVS")
library(SubnationalCRVS)
library(dplyr)
my_plots_dir <- "Plots/"
dir.create(my_plots_dir)
knitr::opts_chunk$set(echo = TRUE)
```

# View the first few rows of the data
```{r "configure_demo", warning=FALSE, message=FALSE}
head(ecuador_age_tabulation)
head(example_data_ecuador)
```

# Conduct DDQA
## Sex ratio
```{r "sex_ratios", message=FALSE, warning=FALSE}
s <- PlotSexRatios(data=example_data_ecuador,
                   name.disaggregations="province_name",
                   name.males="m",
                   name.females="f",
                   name.age="age",
                   name.sex="sex",
                   name.date1="date1",
                   name.date2="date2",
                   name.population.year1="pop1",
                   name.population.year2="pop2",
                   line.size.overall=0.6,
                   print.disaggregated=FALSE,
                   print.overall=FALSE,
                   plots.dir="Plots/")
```
### View sex ratios in table
```{r Â¨sex_ratios_table"}
s %>% select(province_name, age, pop1, pop2, sex_ratio_1, sex_ratio_2) %>%
      head()
```

### View sex ratios in combined plot 
```{r "plot_sex_ratio_combined", echo=TRUE, fig.cap="Sex ratios in Ecuador by province, combined plot", fig.align="center", fig.pos="H", out.width = "60%"}
knitr::include_graphics(path=paste0(my_plots_dir,
                                   "sex_ratios_combined_province_name_",
                                   Sys.Date(),
                                   ".pdf"))
```

### View sex ratios in disaggregated plots
```{r "plot_sex_ratio_disaggregated", echo=TRUE, fig.cap="Sex ratios in Ecuador by province, disaggregated plots", fig.align="center", fig.pos="H", out.width = "60%"}
knitr::include_graphics(path=paste0(my_plots_dir,
                                   "sex_ratios_by_province_name_",
                                   Sys.Date(),
                                   ".pdf"))
```

## Age ratios
```{r "age_ratios", message=FALSE, warning=FALSE, eval=TRUE}
a <- PlotAgeRatios(data=example_data_ecuador,
              name.disaggregations="province_name",
              name.males="m",
              name.females="f",
              name.age="age",
              name.sex="sex",
              name.date1="date1",
              name.date2="date2",
              name.population.year1="pop1",
              name.population.year2="pop2",
              line.size.overall=0.6,
              print.disaggregated=FALSE,
              print.overall=FALSE,
              plots.dir="Plots/")
```
### View age ratios in table
```{r "age_ratios_table"}
a %>% select(province_name, age, pop1, pop2, age_ratio_1, age_ratio_2) %>%
      head()
```
### View age ratios in combined plot
```{r "plot_age_ratios_combined", echo=TRUE, fig.cap="Age ratios in Ecuador by province, combined plot", fig.align="center", fig.pos="H", out.width = "60%"}
knitr::include_graphics(path=paste0(my_plots_dir,
                                   "age_ratios_combined_province_name_",
                                   Sys.Date(),
                                   ".pdf"))

```

### View age ratios in disaggregated plots
```{r "plot_age_ratios_disaggreagted", echo=TRUE, fig.cap="Age ratios in Ecuador by province, disaggregated plots", fig.align="center", fig.pos="H", out.width = "60%"}
knitr::include_graphics(path=paste0(my_plots_dir,
                                   "age_ratios_by_province_name_",
                                   Sys.Date(),
                                   ".pdf"))

```

## Potential age heaping
```{r "age_heaping", message=FALSE, warning=FALSE, eval=TRUE}
PlotPotentialAgeHeaping(data=ecuador_age_tabulation,
            name.disaggregations="province_name",
              name.males="m",
              name.females="f",
              name.age="age",
              name.sex="sex",
              name.date1="date1",
              name.date2="date2",
              name.population.year1="pop1",
              name.population.year2="pop2",
              print.disaggregated=FALSE,
              print.overall=FALSE,
              plots.dir="Plots/")
```

### View potential age heaping in combined plot
```{r "plot_age_heaping_combined", echo=TRUE, fig.cap="Population counts in Ecuador by single-year age, combined plot", fig.align="center", fig.pos="H", out.width = "60%", eval=TRUE}
knitr::include_graphics(path=paste0(my_plots_dir,
                                   "potential_age_heaping_combined_province_name_",
                                   Sys.Date(),
                                   ".pdf"))

```

### View potential age heaping in disaggregated plots
```{r "plot_age_heaping_disaggregated", echo=TRUE, fig.cap="Population counts in Ecuador by single-year age, disaggregated plots", fig.align="center", fig.pos="H", out.width = "60%", eval=TRUE}
knitr::include_graphics(path=paste0(my_plots_dir,
                                   "potential_age_heaping_by_province_name_",
                                   Sys.Date(),
                                   ".pdf"))

```


## Age heaping indices
```{r "age_heaping_scores", message=FALSE, warning=FALSE, eval=TRUE}
ageheaping <- PlotAgeHeapingScores(data=ecuador_age_tabulation,
                                      name.disaggregations="province_name_short",
                                      name.males="m",
                                      name.females="f",
                                      name.age="age",
                                      name.sex="sex",
                                      name.date1="date1",
                                      name.date2="date2",
                                      name.population.year1="pop1",
                                      name.population.year2="pop2",
                                      print.plots=FALSE,
                                      plots.dir="Plots/")
```
### View age heaping indices in table
```{r "age_heaping_indices_table"}
head(ageheaping)
```
### View age heaping indices in plots
```{r "plot_age_heaping_indices", echo=TRUE, fig.cap="Age heaping indices in Ecuador by province", fig.align="center", fig.pos="H", out.width = "60%", eval=TRUE}
knitr::include_graphics(path=paste0(my_plots_dir,
                                   "age_heaping_scores_combined_province_name_short_",
                                   Sys.Date(),
                                   ".pdf"))
```

# DDM estimation
## Compute DDM estimates
```{r "estimate_DDM", message=TRUE, warning=FALSE, eval=TRUE}
ddm_results <- EstimateDDM(data=example_data_ecuador, 
            name.disaggregations="province_name",
            name.age="age",
            name.sex="sex",
            name.males="m",
            name.females="f",
            name.date1="date1",
            name.date2="date2",
            name.population.year1="pop1",
            name.population.year2="pop2",
            name.deaths="deaths",
            deaths.summed=TRUE,
            min.age.in.search=15,
            max.age.in.search=75,
            min.number.of.ages=8)
```

### View DDM point estimates in table 
```{r "DDM_point_estimates_table", message=TRUE, warning=FALSE, eval=TRUE}
head(ddm_results$ddm_estimates)
```

### View age-range sensitivity of DDM point estimates in table 
```{r "DDM_sensitivity_estimates_table", message=TRUE, warning=FALSE, eval=TRUE}
head(ddm_results$sensitivity_ddm_estimates)
```

## Plot DDM estimates
```{r "plot_DDM", message=FALSE, warning=FALSE, eval=TRUE}
PlotDDM(ddm_results=ddm_results,
        label.completeness="Estimated Completeness (%)",
        label.subnational.levels="Province",
        plots.dir="Plots/")
```

### View DDM point estimates in plot
```{r "DDM_point_estimates_in_plot", echo=TRUE, fig.cap="Point estimates of death registration completeness in Ecuador from 2001-2010, using the GGB-SEG method", fig.align="center", fig.pos="H", out.width = "60%", eval=TRUE}
knitr::include_graphics(path=paste0(my_plots_dir,
                                   "ddm_point_estimates_combined_province_name_",
                                   Sys.Date(),
                                   ".pdf"))
```

### View sensitivity of DDM point estimates in plot
```{r "DDM_sensitivity_estimates_in_plot", echo=TRUE, fig.cap="Sensitivity of point estimates of death registration completeness in Ecuador from 2001-2010 to choice of age-range parameter in the GGB-SEG method", fig.align="center", fig.pos="H", out.width = "60%", eval=TRUE}
knitr::include_graphics(path=paste0(my_plots_dir,
                                   "ddm_sensitivity_province_name_",
                                   Sys.Date(),
                                   ".pdf"))
```


