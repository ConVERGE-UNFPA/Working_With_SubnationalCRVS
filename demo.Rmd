---
title: "SubnationalCRVS Demo"
author: "Jeremy Roth"
date: ''
output:
  pdf_document:
    toc: yes
  html_document:
    number_sections: yes
    toc: yes
header-includes:
 \usepackage{float}
---

```{r "clear", include=FALSE}
rm(list=ls())
```

# setting up
## load SubnationalCRVS package (includes example data)
```{r "load_package", message=FALSE, warning=FALSE}
library(SubnationalCRVS)
```

## additional settings for the demo
```{r "configure_demo", warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(knitr)
my_plots_dir <- "Plots/"
```

# Conduct DDQA
## sex ratio
```{r "sex_ratios", message=FALSE, warning=FALSE}
s <- PlotSexRatios(data=example_data_ecuador,
                   name.disaggregations="province_name",
                   name.males="m",
                   name.females="f",
                   name.age="age",
                   name.sex="sex",
                   name.date1="date1",
                   name.date2="date2",
                   name.population.year1="pop1",
                   name.population.year2="pop2",
                   line.size.overall=0.6,
                   print.disaggregated=FALSE,
                   print.overall=FALSE,
                   plots.dir="Plots/")
```
### view sex ratios in table
```{r Â¨sex_ratios_table"}
s %>% select(province_name, age, pop1, pop2, sex_ratio_1, sex_ratio_2) %>%
      head()
```

### view sex ratios in plot 
```{r echo=FALSE, fig.cap="A caption", fig.align="center", fig.pos="H", out.width = "60%"}
knitr::include_graphics(path=paste0(my_plots_dir,
                                   "sex_ratios_combined_province_name_",
                                   Sys.Date(),
                                   ".pdf"))
```

## age ratios
```{r "age_ratios", message=FALSE, warning=FALSE, eval=TRUE}
a <- PlotAgeRatios(data=example_data_ecuador,
              name.disaggregations="province_name",
              name.males="m",
              name.females="f",
              name.age="age",
              name.sex="sex",
              name.date1="date1",
              name.date2="date2",
              name.population.year1="pop1",
              name.population.year2="pop2",
              line.size.overall=0.6,
              print.disaggregated=FALSE,
              print.overall=FALSE,
              plots.dir="Plots/")
```
### view age ratios in table
```{r "age_ratios_table"}
a %>% select(province_name, age, pop1, pop2, age_ratio_1, age_ratio_2) %>%
      head()
```
### view age ratios in plot
```{r "age_ratios_in_plot", echo=FALSE, fig.cap="A caption", fig.align="center", fig.pos="H", out.width = "60%"}
knitr::include_graphics(path=paste0(my_plots_dir,
                                   "age_ratios_combined_province_name_",
                                   Sys.Date(),
                                   ".pdf"))

```

## potential age heaping
```{r "age_heaping", message=FALSE, warning=FALSE, eval=TRUE}
 PlotPotentialAgeHeaping(data=ecuador_age_tabulation,
              name.disaggregations="province_name",
              name.males="m",
              name.females="f",
              name.age="age",
              name.sex="sex",
              name.date1="date1",
              name.date2="date2",
              name.population.year1="pop1",
              name.population.year2="pop2",
              print.disaggregated=FALSE,
              print.overall=FALSE,
              plots.dir="Plots/")
```

## age heaping scores
```{r "age_heaping_scores", message=FALSE, warning=FALSE, eval=TRUE}
ageheaping <- PlotAgeHeapingScores(data=ecuador_age_tabulation,
                                      name.disaggregations="province_name_short",
                                      name.males="m",
                                      name.females="f",
                                      name.age="age",
                                      name.sex="sex",
                                      name.date1="date1",
                                      name.date2="date2",
                                      name.population.year1="pop1",
                                      name.population.year2="pop2",
                                      plots.dir="Plots/")
head(ageheaping)
```

# DDM estimation
## computing DDM estimates
```{r "estimate_DDM", message=TRUE, warning=FALSE, eval=TRUE}
ddm_results <- EstimateDDM(data=example_data_ecuador, 
            name.disaggregations="province_name",
            name.age="age",
            name.sex="sex",
            name.males="m",
            name.females="f",
            name.date1="date1",
            name.date2="date2",
            name.population.year1="pop1",
            name.population.year2="pop2",
            name.deaths="deaths",
            deaths.summed=TRUE,
            min.age.in.search=15,
            max.age.in.search=75,
            min.number.of.ages=8)
head(ddm_results$ddm_estimates)
head(ddm_results$sensitivity_ddm_estimates)
```
## plotting DDM estimates
```{r "plot_DDM", message=FALSE, warning=FALSE, eval=TRUE}
PlotDDM(ddm_results=ddm_results,
        size.text.sensitivity=8,
        plots.dir="Plots/")
```


